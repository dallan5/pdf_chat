<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}" />
    <style>
        .main-container {
            display: flex;
        }

        .pdf-container,
        .chat-container {
            flex: 1;
            padding: 10px;
        }

        .pdf-object {
            width: 100%;
            height: 400px;
        }
    </style>
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <div class="main-container">
        <!-- PDF Container on the Left -->
        <div id="pdf-wrapper" style="flex: 1; padding: 10px; height: 100vh;"></div>

        <!-- Chat Container on the Right -->
        <div class="chat-container">
            <img src="{{ url_for('static', filename='tutor.png') }}" class="icon" />
            <h3>Chat Window</h3>

            <div id="chat-window">
                {% for message in messages %}
                {% if loop.index > 1 %}
                <div class="{{ message.role }} markdown">{{ message.content|safe }}</div>
                {% endif %}
                {% endfor %}
            </div>

            <form action="/" method="post">
                <input type="text" name="query" placeholder="Type your message..." required />
                <input type="submit" value="Send" />
            </form>
        </div>
    </div>

    <!-- Start of JavaScript -->
    <script>
        let latestSelectedText = "";

        document.querySelector("form").addEventListener("submit", function (event) {
            event.preventDefault();

            const formData = new FormData(event.target);
            const formObject = {};
            formData.forEach((value, key) => {
                formObject[key] = value;
            });

            const chatWindow = document.getElementById("chat-window");
            const userMessage = document.createElement("div");
            userMessage.className = "user";
            userMessage.textContent = formObject.query;
            chatWindow.appendChild(userMessage);

            fetch("/", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formObject)
            })
                .then(response => response.json())
                .then(data => {
                    const aiMessage = document.createElement("div");
                    aiMessage.className = data.role || "assistant";
                    aiMessage.innerHTML = data.message;
                    chatWindow.appendChild(aiMessage);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                })
                .catch(error => {
                    console.error("Error:", error);
                });
        });

    </script>

    <script src="{{ url_for('static', filename='libs/PDFJSExpress/lib/webviewer.min.js') }}"></script>

    <script>
        WebViewer({
            path: "{{ url_for('static', filename='libs/PDFJSExpress/lib') }}",
            initialDoc: "{{ url_for('static', filename='pdf/book.pdf') }}",
            disabledElements: ["header", "annotation"],
        }, document.getElementById('pdf-wrapper'))
            .then(instance => {
                instance.UI.setTheme('dark');
                instance.UI.disableFeatures([instance.UI.Feature.Print, instance.UI.Feature.Annotations]);

                const {
                    documentViewer
                } = instance.Core;

                documentViewer.addEventListener('pageNumberUpdated', (pageNumber) => {
                    console.log(`Switched to page: ${pageNumber}`);

                    fetch('/capture_text', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            page_number: pageNumber,
                        }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        console.log(data);
                    })
                    .catch((error) => {
                        console.error('Error:', error);
                    });

                });
            });

    </script>

</body>

</html>
